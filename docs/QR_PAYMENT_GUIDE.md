# T√†i li·ªáu Thanh to√°n QR - H∆∞·ªõng d·∫´n b·∫£o v·ªá lu·∫≠n vƒÉn

## 1. T·ªïng quan h·ªá th·ªëng

### 1.1. M√¥ h√¨nh thanh to√°n QR

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     1. ƒê·∫∑t h√†ng + ch·ªçn QR     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                 ‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ                  ‚îÇ
‚îÇ   Customer App  ‚îÇ                               ‚îÇ    Backend API   ‚îÇ
‚îÇ   (React Native)‚îÇ     2. Tr·∫£ v·ªÅ QR URL         ‚îÇ   (Spring Boot)  ‚îÇ
‚îÇ                 ‚îÇ ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                               ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ                                                 ‚îÇ
         ‚îÇ 3. Hi·ªÉn th·ªã QR                                 ‚îÇ
         ‚îÇ    Countdown 5 ph√∫t                            ‚îÇ 4. Scheduler
         ‚îÇ    Polling m·ªói 5s                              ‚îÇ    Auto-confirm
         ‚ñº                                                 ‚îÇ    sau 30-60s
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                               ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                 ‚îÇ     5. Qu√©t QR & CK          ‚îÇ                  ‚îÇ
‚îÇ   VietQR Image  ‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ   MB Bank        ‚îÇ
‚îÇ   (QR Code)     ‚îÇ                               ‚îÇ   STK: 037189928 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                               ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 1.2. Th√†nh ph·∫ßn h·ªá th·ªëng

| Component | C√¥ng ngh·ªá | Ch·ª©c nƒÉng |
|-----------|-----------|-----------|
| Frontend | React Native + Expo | Hi·ªÉn th·ªã QR, countdown, polling |
| Backend | Spring Boot | Sinh QR, check status, auto-confirm |
| QR Service | VietQR.io API | Sinh h√¨nh ·∫£nh QR chu·∫©n NAPAS |
| Database | MySQL | L∆∞u tr·∫°ng th√°i thanh to√°n |

## 2. Flow chi ti·∫øt

### 2.1. ƒê·∫∑t h√†ng v·ªõi QR Payment

```
1. Customer ch·ªçn s·∫£n ph·∫©m ‚Üí Th√™m v√†o gi·ªè h√†ng
2. Checkout ‚Üí Ch·ªçn "Chuy·ªÉn kho·∫£n QR (MB Bank)"
3. Nh·∫•n "ƒê·∫∑t h√†ng" ‚Üí API t·∫°o Order v·ªõi paymentMethod = QR_TRANSFER
4. Backend:
   - T·∫°o Order v·ªõi tr·∫°ng th√°i PENDING
   - Sinh m√£ giao d·ªãch: DH{orderId}_{timestamp}
   - T·∫°o VietQR URL v·ªõi s·ªë ti·ªÅn + n·ªôi dung CK
   - L∆∞u qrCodeUrl, qrExpiredAt (NOW + 5 ph√∫t)
5. Frontend nh·∫≠n qrCodeUrl ‚Üí Hi·ªÉn th·ªã m√†n h√¨nh QrPaymentScreen
```

### 2.2. M√†n h√¨nh thanh to√°n QR

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  ‚Üê  Thanh to√°n QR                      ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                        ‚îÇ
‚îÇ    ‚è±Ô∏è M√£ QR h·∫øt h·∫°n sau: 04:32        ‚îÇ
‚îÇ                                        ‚îÇ
‚îÇ    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ    ‚îÇ                              ‚îÇ   ‚îÇ
‚îÇ    ‚îÇ          [QR CODE]           ‚îÇ   ‚îÇ
‚îÇ    ‚îÇ                              ‚îÇ   ‚îÇ
‚îÇ    ‚îÇ     Qu√©t b·∫±ng app NH         ‚îÇ   ‚îÇ
‚îÇ    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ                                        ‚îÇ
‚îÇ    üìã Th√¥ng tin chuy·ªÉn kho·∫£n          ‚îÇ
‚îÇ    ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ   ‚îÇ
‚îÇ    Ng√¢n h√†ng:  MB Bank (Qu√¢n ƒë·ªôi)     ‚îÇ
‚îÇ    S·ªë TK:      037189928    [üìã]      ‚îÇ
‚îÇ    Ch·ªß TK:     SHOP ECOMMERCE         ‚îÇ
‚îÇ    S·ªë ti·ªÅn:    500,000 ‚Ç´              ‚îÇ
‚îÇ    N·ªôi dung:   DH123_1699...  [üìã]    ‚îÇ
‚îÇ                                        ‚îÇ
‚îÇ    üìù H∆∞·ªõng d·∫´n                        ‚îÇ
‚îÇ    1. M·ªü app ng√¢n h√†ng                 ‚îÇ
‚îÇ    2. Qu√©t m√£ QR ho·∫∑c nh·∫≠p th√¥ng tin  ‚îÇ
‚îÇ    3. X√°c nh·∫≠n thanh to√°n             ‚îÇ
‚îÇ    4. ƒê·ª£i h·ªá th·ªëng x√°c nh·∫≠n (30-60s)  ‚îÇ
‚îÇ                                        ‚îÇ
‚îÇ    üîÑ ƒêang ch·ªù thanh to√°n...          ‚îÇ
‚îÇ                                        ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  [  H·ªßy v√† ch·ªçn ph∆∞∆°ng th·ª©c kh√°c  ]   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 2.3. Auto-confirm (Mock cho demo)

```java
// QrPaymentScheduler.java - Ch·∫°y m·ªói 10 gi√¢y
@Scheduled(fixedRate = 10000)
public void autoConfirmPayment() {
    // 1. T√¨m ƒë∆°n h√†ng QR_TRANSFER + PENDING
    // 2. ƒê√£ t·∫°o QR t·ª´ 30-60 gi√¢y
    // 3. Ch∆∞a h·∫øt h·∫°n (qrExpiredAt > NOW)
    // 4. Auto chuy·ªÉn sang PAID
}
```

**Gi·∫£i th√≠ch khi h·ªèi:**
- Trong th·ª±c t·∫ø: Ng√¢n h√†ng g·ª≠i webhook khi nh·∫≠n ti·ªÅn
- Demo lu·∫≠n vƒÉn: Scheduler t·ª± ƒë·ªông confirm ƒë·ªÉ m√¥ ph·ªèng
- Random delay 30-60s ƒë·ªÉ t·ª± nhi√™n h∆°n

## 3. API Endpoints

### 3.1. T·∫°o QR Payment

```
POST /api/payments/qr/{orderId}

Response:
{
  "orderId": 123,
  "qrCodeUrl": "https://img.vietqr.io/image/MB-037189928-compact2.png?amount=500000&addInfo=DH123_1699...",
  "transactionId": "DH123_1699876543210",
  "expiredAt": "2024-01-15T10:05:00",
  "expiryMinutes": 5,
  "amount": 500000,
  "bankId": "MB",
  "bankAccount": "037189928",
  "accountName": "SHOP ECOMMERCE"
}
```

### 3.2. Check Status (Polling)

```
GET /api/payments/qr/{orderId}/status

Response:
{
  "orderId": 123,
  "paymentStatus": "PENDING" | "PAID" | "FAILED",
  "isQrExpired": false,
  "qrExpiredAt": "2024-01-15T10:05:00",
  "paidAt": null,
  "amount": 500000
}
```

### 3.3. H·ªßy QR Payment

```
POST /api/payments/qr/{orderId}/cancel

Response:
{
  "success": true,
  "message": "ƒê√£ h·ªßy thanh to√°n QR"
}
```

## 4. VietQR Integration

### 4.1. V·ªÅ VietQR

- **VietQR** l√† h·ªá th·ªëng QR li√™n ng√¢n h√†ng c·ªßa NAPAS
- H·ªó tr·ª£ **40+ ng√¢n h√†ng** t·∫°i Vi·ªát Nam
- User c√≥ th·ªÉ qu√©t b·∫±ng app ng√¢n h√†ng ho·∫∑c v√≠ ƒëi·ªán t·ª≠

### 4.2. VietQR URL Format

```
https://img.vietqr.io/image/{BANK_ID}-{ACCOUNT}-{TEMPLATE}.png
  ?amount={AMOUNT}
  &addInfo={CONTENT}
  &accountName={ACCOUNT_NAME}
```

**V√≠ d·ª•:**
```
https://img.vietqr.io/image/MB-037189928-compact2.png
  ?amount=500000
  &addInfo=DH123_1699876543210
  &accountName=SHOP%20ECOMMERCE
```

### 4.3. Bank ID c·ªßa c√°c ng√¢n h√†ng ph·ªï bi·∫øn

| Bank | Bank ID |
|------|---------|
| MB Bank | MB |
| Vietcombank | VCB |
| Techcombank | TCB |
| BIDV | BIDV |
| Agribank | VBA |
| VPBank | VPB |

## 5. Database Schema

### 5.1. B·∫£ng Orders (m·ªü r·ªông)

```sql
CREATE TABLE orders (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  -- ... existing columns ...
  
  -- QR Payment columns
  payment_method ENUM('COD', 'QR_TRANSFER') DEFAULT 'COD',
  qr_code_url TEXT,
  qr_expired_at DATETIME,
  payment_transaction_id VARCHAR(100),
  paid_at DATETIME,
  
  -- Status
  payment_status ENUM('PENDING', 'PAID', 'FAILED', 'CANCELLED') DEFAULT 'PENDING',
  
  INDEX idx_payment_transaction_id (payment_transaction_id),
  INDEX idx_payment_status (payment_status)
);
```

### 5.2. PaymentMethod Enum

```java
public enum PaymentMethod {
    COD,            // Thanh to√°n khi nh·∫≠n h√†ng
    QR_TRANSFER     // Chuy·ªÉn kho·∫£n qua QR
}
```

## 6. B·∫£o m·∫≠t

### 6.1. C√°c bi·ªán ph√°p b·∫£o m·∫≠t ƒë√£ √°p d·ª•ng

| Bi·ªán ph√°p | M√¥ t·∫£ |
|-----------|-------|
| QR Expiry | QR ch·ªâ c√≥ hi·ªáu l·ª±c 5 ph√∫t |
| Unique TransactionId | M·ªói ƒë∆°n c√≥ m√£ giao d·ªãch ri√™ng ƒë·ªÉ ƒë·ªëi so√°t |
| Status Check | Ki·ªÉm tra tr·∫°ng th√°i tr∆∞·ªõc khi confirm |
| JWT Auth | T·∫•t c·∫£ API y√™u c·∫ßu token h·ª£p l·ªá |

### 6.2. Production Recommendations

```
1. Webhook t·ª´ Payment Gateway:
   - Nh·∫≠n callback t·ª´ ng√¢n h√†ng khi c√≥ giao d·ªãch
   - Verify signature ƒë·ªÉ ƒë·∫£m b·∫£o request h·ª£p l·ªá
   
2. ƒê·ªëi so√°t t·ª± ƒë·ªông:
   - So s√°nh n·ªôi dung CK v·ªõi transactionId
   - Ki·ªÉm tra s·ªë ti·ªÅn kh·ªõp v·ªõi ƒë∆°n h√†ng
   
3. Rate Limiting:
   - Gi·ªõi h·∫°n s·ªë l·∫ßn t·∫°o QR / user / th·ªùi gian
   - Tr√°nh spam t·∫°o QR
```

## 7. C√¢u h·ªèi b·∫£o v·ªá th∆∞·ªùng g·∫∑p

### Q1: T·∫°i sao kh√¥ng t√≠ch h·ª£p payment gateway th·∫≠t?

**Tr·∫£ l·ªùi:**
- Payment gateway th·∫≠t (VNPAY, Momo) y√™u c·∫ßu:
  - ƒêƒÉng k√Ω merchant account
  - Verification business license
  - Integration testing v·ªõi sandbox
- V·ªõi lu·∫≠n vƒÉn, mock auto-confirm ƒë·ªß demo flow
- Ki·∫øn tr√∫c ƒë√£ s·∫µn s√†ng ƒë·ªÉ thay webhook th·∫≠t

### Q2: L√†m sao ƒë·∫£m b·∫£o user ƒë√£ chuy·ªÉn ti·ªÅn th·∫≠t?

**Tr·∫£ l·ªùi:**
- Production: Webhook t·ª´ ng√¢n h√†ng + ƒë·ªëi so√°t transactionId
- Demo: Scheduler m√¥ ph·ªèng vi·ªác ng√¢n h√†ng x√°c nh·∫≠n
- N·ªôi dung CK c√≥ m√£ ƒë∆°n h√†ng ƒë·ªÉ ƒë·ªëi so√°t

### Q3: N·∫øu QR h·∫øt h·∫°n th√¨ sao?

**Tr·∫£ l·ªùi:**
- Frontend hi·ªÉn th·ªã th√¥ng b√°o "QR ƒë√£ h·∫øt h·∫°n"
- User c√≥ th·ªÉ:
  1. T·∫°o QR m·ªõi (nh·∫•n "Th·ª≠ l·∫°i")
  2. ƒê·ªïi sang COD (nh·∫•n "Ch·ªçn ph∆∞∆°ng th·ª©c kh√°c")
- Backend ƒë√°nh d·∫•u paymentStatus = FAILED

### Q4: Polling c√≥ ·∫£nh h∆∞·ªüng performance kh√¥ng?

**Tr·∫£ l·ªùi:**
- Polling interval: 5 gi√¢y (kh√¥ng qu√° nhanh)
- Max polling time: 5 ph√∫t (QR expiry)
- Server side: Query ƒë∆°n gi·∫£n theo orderId (indexed)
- Alternative: WebSocket (ph·ª©c t·∫°p h∆°n cho demo)

### Q5: T·∫°i sao d√πng VietQR thay v√¨ t·ª± sinh QR?

**Tr·∫£ l·ªùi:**
- VietQR l√† chu·∫©n qu·ªëc gia, ƒë∆∞·ª£c ng√¢n h√†ng c√¥ng nh·∫≠n
- T·ª± sinh QR ph·∫£i tu√¢n th·ªß EMVCo standard
- VietQR t·ª± ƒë·ªông format ƒë√∫ng cho t·ª´ng ng√¢n h√†ng
- API mi·ªÖn ph√≠, kh√¥ng c·∫ßn ƒëƒÉng k√Ω

## 8. Files quan tr·ªçng

### Backend (Spring Boot)
- `PaymentMethod.java` - Enum ph∆∞∆°ng th·ª©c thanh to√°n
- `Order.java` - Entity v·ªõi c√°c tr∆∞·ªùng QR m·ªõi
- `PaymentService.java` - Business logic sinh QR, check status
- `PaymentController.java` - REST API endpoints
- `QrPaymentScheduler.java` - Auto-confirm scheduler

### Frontend (React Native)
- `paymentService.ts` - API client cho payment
- `QrPaymentScreen.tsx` - UI m√†n h√¨nh thanh to√°n QR
- `CheckoutView.tsx` - C·∫≠p nh·∫≠t ƒë·ªÉ t√≠ch h·ª£p QR option

## 9. Demo Script

```
1. M·ªü app Customer ‚Üí Th√™m s·∫£n ph·∫©m v√†o gi·ªè h√†ng
2. Checkout ‚Üí Ch·ªçn "Chuy·ªÉn kho·∫£n QR (MB Bank)"
3. ƒê·∫∑t h√†ng ‚Üí Chuy·ªÉn sang m√†n h√¨nh QR
4. Hi·ªÉn th·ªã:
   - M√£ QR (c√≥ th·ªÉ scan th·∫≠t)
   - Countdown 5 ph√∫t
   - Th√¥ng tin bank
5. ƒê·ª£i 30-60 gi√¢y ‚Üí Auto confirm
6. Alert "Thanh to√°n th√†nh c√¥ng" ‚Üí Navigate to orders
7. Ki·ªÉm tra order ‚Üí Status = PAID
```
